# PostgreSQL Migration Guide

## üìö Overview

This document explains the complete migration from MySQL to PostgreSQL for the Chitrasethu Photography Platform backend. All backend code has been updated to use PostgreSQL as the database system.

---

## üîÑ What Changed

### 1. **Database Package**
- **Before:** `mysql2` package
- **After:** `pg` (node-postgres) package

### 2. **Database Configuration**
- **Port:** Changed from `3306` (MySQL) to `5432` (PostgreSQL)
- **Default User:** Changed from `root` to `postgres`
- **Connection Method:** Using `pg.Pool` instead of `mysql2.createPool()`

### 3. **SQL Syntax Changes**

#### Parameter Placeholders
- **MySQL:** Uses `?` for placeholders
  ```sql
  SELECT * FROM users WHERE email = ?
  ```
- **PostgreSQL:** Uses `$1, $2, $3...` for numbered placeholders
  ```sql
  SELECT * FROM users WHERE email = $1
  ```

#### Boolean Values
- **MySQL:** Uses `1` and `0` or `TRUE`/`FALSE`
  ```sql
  WHERE is_active = 1
  ```
- **PostgreSQL:** Uses `true` and `false` (lowercase)
  ```sql
  WHERE is_active = true
  ```

#### INSERT with RETURNING
- **MySQL:** Uses `insertId` property
  ```javascript
  const result = await query('INSERT INTO users...');
  const userId = result.insertId;
  ```
- **PostgreSQL:** Uses `RETURNING` clause
  ```javascript
  const result = await query('INSERT INTO users... RETURNING user_id');
  const userId = result[0].user_id;
  ```

#### JSON Operations
- **MySQL:** Uses `JSON_CONTAINS()` for JSON queries
  ```sql
  WHERE JSON_CONTAINS(specialties, ?)
  ```
- **PostgreSQL:** Uses `@>` operator with JSONB
  ```sql
  WHERE specialties @> $1::jsonb
  ```

#### Case-Insensitive Search
- **MySQL:** Uses `LIKE`
  ```sql
  WHERE city LIKE '%Mumbai%'
  ```
- **PostgreSQL:** Uses `ILIKE` for case-insensitive
  ```sql
  WHERE city ILIKE '%Mumbai%'
  ```

### 4. **Data Types**

| MySQL | PostgreSQL |
|-------|-----------|
| `INT AUTO_INCREMENT` | `INT GENERATED BY DEFAULT AS IDENTITY` |
| `ENUM('a','b','c')` | Custom ENUM type or CHECK constraint |
| `JSON` | `JSONB` (binary, more efficient) |
| `DATETIME` | `TIMESTAMP` |
| `BOOLEAN` | `BOOLEAN` (native) |
| `VARCHAR(n)` | `VARCHAR(n)` (same) |
| `TEXT` | `TEXT` (same) |
| `DECIMAL(p,s)` | `NUMERIC(p,s)` or `DECIMAL(p,s)` |

---

## üóÑÔ∏è Database Schema

### PostgreSQL-Specific Features Used

1. **Custom ENUM Types**
   ```sql
   CREATE TYPE user_type_enum AS ENUM ('customer', 'photographer', 'admin');
   CREATE TYPE booking_status_enum AS ENUM ('pending', 'confirmed', 'in_progress', 'completed', 'cancelled', 'refunded');
   ```

2. **JSONB Columns**
   - More efficient than JSON
   - Supports indexing
   - Native operators like `@>`, `?`, `?|`, `?&`

3. **Triggers for Automatic Timestamps**
   ```sql
   CREATE OR REPLACE FUNCTION update_updated_at_column()
   RETURNS TRIGGER AS $$
   BEGIN
       NEW.updated_at = CURRENT_TIMESTAMP;
       RETURN NEW;
   END;
   $$ LANGUAGE plpgsql;
   ```

4. **Views**
   - `view_users_complete`
   - `view_photographers_complete`
   - `view_bookings_active`

---

## ‚öôÔ∏è Installation & Setup

### Step 1: Install PostgreSQL

#### Windows
1. Download from [postgresql.org](https://www.postgresql.org/download/windows/)
2. Run installer
3. Remember the password you set for `postgres` user
4. Default port: 5432

#### macOS
```bash
brew install postgresql@15
brew services start postgresql@15
```

#### Linux (Ubuntu/Debian)
```bash
sudo apt update
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql
sudo systemctl enable postgresql
```

### Step 2: Create Database

Connect to PostgreSQL:
```bash
# Windows Command Prompt
psql -U postgres

# macOS/Linux
sudo -u postgres psql
```

Create the database:
```sql
CREATE DATABASE chitrasethu;
\q
```

### Step 3: Install Node.js Dependencies

Navigate to the backend folder:
```bash
cd chitrasethu/backend
npm install
```

This will install the `pg` package (version ^8.11.3).

### Step 4: Configure Environment Variables

Copy the example environment file:
```bash
copy env.example .env  # Windows
cp env.example .env    # macOS/Linux
```

Edit `.env` file:
```env
# Database Configuration (PostgreSQL)
DB_HOST=localhost
DB_USER=postgres
DB_PASSWORD=your_postgres_password_here
DB_NAME=chitrasethu
DB_PORT=5432

# Other configurations...
PORT=5000
NODE_ENV=development
JWT_SECRET=your_super_secret_jwt_key_change_this_in_production
JWT_EXPIRE=7d
FRONTEND_URL=http://localhost:5173
```

### Step 5: Run Database Setup

Create tables, enums, triggers, and views:
```bash
npm run db:setup
```

Expected output:
```
üîß Starting database setup...
‚úÖ Connected to PostgreSQL server
üìÑ Reading PostgreSQL schema file...
‚öôÔ∏è  Creating tables, enums, triggers, and views...
‚úÖ Database schema created successfully

üìä Created tables:
   1. booking_payments
   2. booking_reviews
   3. bookings
   ...
```

### Step 6: Seed Sample Data

Insert dummy data:
```bash
npm run db:seed
```

Expected output:
```
üå± Starting database seeding...
‚úÖ Connected to database
üìÑ Reading PostgreSQL seed data file...
‚öôÔ∏è  Inserting seed data...
‚úÖ Seed data inserted successfully

üìä Data Summary:
   Users: 8 records
   Photographers: 4 records
   Events: 5 records
   Bookings: 4 records
   Posts: 5 records

üìù Test Credentials:
   Customer: customer1@example.com / Password123!
   Photographer: arjun.kapoor@example.com / Password123!
   Admin: admin@chitrasethu.com / Password123!
```

### Step 7: Start the Server

```bash
npm run serve  # or npm start
```

Expected output:
```
‚úÖ Database connected successfully
üìä Connected to: chitrasethu
‚è∞ Server time: 2024-11-12 10:30:00...

üöÄ ============================================
üöÄ Chitrasethu Backend Server
üöÄ Environment: development
üöÄ Server running on: http://localhost:5000
üöÄ API endpoint: http://localhost:5000/api
üöÄ ============================================
```

---

## üîß Database Utility Scripts

### Reset Database (Clear All Data)
```bash
npm run db:reset
```

‚ö†Ô∏è **Warning:** This will drop all tables and data!

### Verify Setup
```bash
npm run verify
```

---

## üìù Code Changes Summary

### Files Updated

1. **`src/config/database.js`**
   - Replaced `mysql2` with `pg`
   - Updated connection pool configuration
   - Changed query method to return `result.rows`
   - Added `convertPlaceholders()` helper function

2. **`src/controllers/auth.controller.js`**
   - Changed all `?` to `$1, $2, $3...`
   - Updated INSERT queries to use `RETURNING` clause
   - Changed array destructuring for single row results

3. **`src/controllers/photographer.controller.js`**
   - Updated filter queries for PostgreSQL syntax
   - Changed `JSON_CONTAINS()` to `@>` operator
   - Changed `LIKE` to `ILIKE` for case-insensitive search
   - Removed JSON.parse() calls (JSONB returns objects directly)

4. **`src/controllers/post.controller.js`**
   - Updated parameter placeholders
   - Changed boolean comparison from `= 1` to `= true`
   - Removed JSON.parse() for JSONB columns

5. **`src/database/setup.js`**
   - Replaced `mysql2` with `pg`
   - Updated to read `schema_postgres.sql`
   - Changed table listing query to use `information_schema`

6. **`src/database/seed.js`**
   - Updated to use PostgreSQL client
   - Changed to read `seed_postgres.sql`
   - Updated verification query syntax

7. **`src/database/reset.js`**
   - Updated to drop PostgreSQL schema instead of database
   - Uses `DROP SCHEMA public CASCADE`

8. **`database/schema_postgres.sql`** (NEW)
   - PostgreSQL-native schema with ENUM types
   - JSONB columns instead of JSON
   - Identity columns instead of AUTO_INCREMENT
   - Triggers for automatic timestamp updates

9. **`database/seed_postgres.sql`** (NEW)
   - Sample data with PostgreSQL syntax
   - JSONB casting for JSON columns
   - ENUM casting for enum columns

10. **`package.json`**
    - Removed `mysql2` dependency
    - Added `pg` dependency (^8.11.3)

11. **`env.example`**
    - Updated default port to 5432
    - Changed default user to `postgres`
    - Added PostgreSQL comment

---

## üß™ Testing the Migration

### 1. Test Database Connection
```bash
npm run verify
```

### 2. Test API Endpoints

#### Register a User
```bash
curl -X POST http://localhost:5000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "Test123!",
    "fullName": "Test User",
    "userType": "customer"
  }'
```

#### Login
```bash
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "customer1@example.com",
    "password": "Password123!"
  }'
```

#### Get Photographers
```bash
curl http://localhost:5000/api/photographers
```

#### Get Posts
```bash
curl http://localhost:5000/api/posts
```

---

## üêõ Common Issues & Solutions

### Issue 1: Connection Refused
**Error:** `ECONNREFUSED 127.0.0.1:5432`

**Solution:**
- Ensure PostgreSQL is running:
  ```bash
  # Windows
  net start postgresql-x64-15
  
  # macOS
  brew services start postgresql@15
  
  # Linux
  sudo systemctl start postgresql
  ```

### Issue 2: Authentication Failed
**Error:** `password authentication failed for user "postgres"`

**Solution:**
- Update `.env` file with correct password
- Reset password if needed:
  ```bash
  psql -U postgres
  ALTER USER postgres WITH PASSWORD 'newpassword';
  ```

### Issue 3: Database Does Not Exist
**Error:** `database "chitrasethu" does not exist`

**Solution:**
```bash
psql -U postgres
CREATE DATABASE chitrasethu;
\q
```

### Issue 4: Permission Denied
**Error:** `permission denied for schema public`

**Solution:**
```sql
GRANT ALL ON SCHEMA public TO postgres;
GRANT ALL ON SCHEMA public TO public;
```

### Issue 5: Port Already in Use
**Error:** `address already in use :::5432`

**Solution:**
- Another PostgreSQL instance is running
- Check and stop it, or use a different port in `.env`

---

## üìä Performance Benefits

### Why PostgreSQL?

1. **Better JSON Support**
   - Native JSONB type with indexing
   - Efficient JSON queries and operations

2. **ACID Compliance**
   - Stronger data consistency
   - Better transaction handling

3. **Advanced Features**
   - Full-text search
   - Array types
   - Custom types and enums
   - Window functions
   - CTEs (Common Table Expressions)

4. **Scalability**
   - Better handling of concurrent connections
   - More efficient for read-heavy workloads

5. **Open Source**
   - Truly open source (BSD license)
   - Large community support

---

## üîê Security Considerations

1. **Never commit `.env` file**
   - Add to `.gitignore`
   - Use strong passwords

2. **Use Connection Pooling**
   - Already configured in `database.js`
   - Prevents connection exhaustion

3. **Prepared Statements**
   - PostgreSQL automatically uses them
   - Protection against SQL injection

4. **SSL/TLS in Production**
   ```javascript
   const dbConfig = {
     // ... other config
     ssl: process.env.NODE_ENV === 'production' ? {
       rejectUnauthorized: false
     } : false
   };
   ```

---

## üìö Additional Resources

- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
- [node-postgres (pg) Documentation](https://node-postgres.com/)
- [PostgreSQL vs MySQL](https://www.postgresql.org/about/)
- [JSONB in PostgreSQL](https://www.postgresql.org/docs/current/datatype-json.html)

---

## üéØ Next Steps

1. ‚úÖ Database migrated to PostgreSQL
2. ‚úÖ All backend code updated
3. ‚úÖ Sample data seeded
4. üîÑ Test all API endpoints
5. üîÑ Update frontend if needed
6. üîÑ Deploy to production

---

## üìû Support

If you encounter any issues during migration:

1. Check the error logs
2. Verify PostgreSQL is running
3. Check `.env` configuration
4. Consult this guide
5. Check PostgreSQL logs:
   - Windows: `C:\Program Files\PostgreSQL\15\data\log\`
   - macOS: `/usr/local/var/log/postgres.log`
   - Linux: `/var/log/postgresql/`

---

**Last Updated:** November 12, 2024  
**Version:** 1.0.0  
**Author:** Chitrasethu Team


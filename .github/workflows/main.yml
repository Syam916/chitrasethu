name: Deploy to AWS EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Ensure Docker is running + Compose available
        run: |
          sudo systemctl start docker || true
          docker --version
          
          # Install Docker Compose if not available
          if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
            echo "Installing Docker Compose..."
            COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d\" -f4)
            sudo curl -L "https://github.com/docker/compose/releases/download/${COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            
            # Also create docker compose V2 alias if needed
            if ! docker compose version &> /dev/null; then
              sudo ln -sf /usr/local/bin/docker-compose /usr/libexec/docker/cli-plugins/docker-compose || true
            fi
          fi
          
          # Verify installation
          if docker compose version &> /dev/null; then
            echo "✓ Docker Compose V2 is available"
            docker compose version
          elif command -v docker-compose &> /dev/null; then
            echo "✓ Docker Compose V1 is available"
            docker-compose --version
          else
            echo "ERROR: Docker Compose not found"
            exit 1
          fi
          
          aws --version

      - name: Login to Amazon ECR (uses EC2 IAM Role)
        run: |
          # Login as root user (since we use sudo for docker commands)
          sudo aws ecr get-login-password --region ap-south-1 \
          | sudo docker login --username AWS --password-stdin 002255676455.dkr.ecr.ap-south-1.amazonaws.com
          
          # Also login as current user (for verification)
          aws ecr get-login-password --region ap-south-1 \
          | docker login --username AWS --password-stdin 002255676455.dkr.ecr.ap-south-1.amazonaws.com || true

      - name: Prepare deployment directory
        run: |
          sudo mkdir -p /opt/chitrasethu
          sudo cp docker-compose.yml /opt/chitrasethu/

      - name: Deploy containers (pull + restart)
        run: |
          cd /opt/chitrasethu
          
          # Use docker compose V2 if available, otherwise fallback to V1
          if docker compose version &> /dev/null; then
            COMPOSE_CMD="docker compose"
          elif command -v docker-compose &> /dev/null; then
            COMPOSE_CMD="docker-compose"
          else
            echo "ERROR: Docker Compose not found"
            exit 1
          fi
          
          sudo $COMPOSE_CMD down || true
          sudo $COMPOSE_CMD pull
          sudo $COMPOSE_CMD up -d --remove-orphans

      - name: Cleanup old images
        run: |
          sudo docker image prune -f

      - name: Verify deployment
        run: |
          echo "Running containers:"
          sudo docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          echo "Local checks:"
          curl -I http://127.0.0.1:3000 || true
          curl -I http://127.0.0.1:5000 || true
